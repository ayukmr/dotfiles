#!/usr/bin/env ruby

# ========================
# === Git Tmux Heatmap ===
# ========================

require 'date'
require 'open3'

class String
  # color string
  def color(code)
    "\e[38;5;#{code}m#{self}\e[0m"
  end
end

def display_heatmap
  # get commits
  commits = Hash.new {0}
  output, = Open3.capture3('git log --pretty=format:%cd')

  # put commits into hash
  output.lines.each do |line|
    commits[Date.parse(line.chomp)] += 1
  end

  width = `stty size`.split[1].to_i
  double = width >= 150

  # get end of current week
  week_end = Date.today + (6 - Date.today.wday)
  past = week_end.prev_month((width / (double ? 20 : 10)).floor)

  # create range of days
  range = (past + (7 - past.wday)..week_end)
  lines = Array.new(7, '')

  range.each do |date|
    amount = commits[date]

    # add block to lines
    lines[date.wday] +=
      if amount.zero?
        '  '
      else
        '██'.color([amount * 6 + 16, 46].min)
      end
  end

  box_width = range.count / 7 * (double ? 4 : 2) + 2
  padding = ' ' * ((width - box_width - 1) / 2)

  lines.map! do |line|
    "#{padding}#{'│'.color(239)} #{line} #{'│'.color(239)}"
  end

  # top padding
  puts

  # display heatmap
  puts "#{padding}┌#{'─' * box_width}┐".color(239)
  puts lines
  puts "#{padding}└#{'─' * box_width}┘".color(239)

  sleep 120
end

loop do
  display_heatmap
end
