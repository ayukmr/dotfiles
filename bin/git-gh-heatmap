#!/usr/bin/env zsh

# ===================
# === Git Heatmap ===
# ===================

vertical=false

while [[ $# > 0 ]]; do
    case $1 in
        # set vertical for vertical mode
        -v | --v | --vertical)
            vertical=true
            ;;

        # error on unknown flag
        -*)
            print -P "%B%F{red}error%f%b: unknown flag \`$1\`"
            exit 1
            ;;
    esac
    shift
done

# get weeks in current month
month=$(( $(cal $(date +'%m %Y') | wc -l) - 3 ))
# get nine months worth of data
weeks=$(( month * 9 ))

count=0
# lines for horizontal output
lines=()

# get data from github api
data=$(
    gh api \
        -H 'Accept: application/vnd.github.v3+json' \
        -q ".[-$weeks:].[].days[]" \
        repos/{owner}/{repo}/stats/commit_activity
)

# draw boxes
if $vertical; then
    print -P '%F{239}┌────────────────┐%f'
    print -nP '%F{239}│ %f'
fi

echo $data | while read -r line; do
    if [[ $count == 7 ]]; then
        count=0
        # draw side borders for box
        if $vertical; then
            print -P  '%F{239} │%f'
            print -nP '%F{239}│ %f'
        fi
    fi

    count=$(( count + 1 ))
    local string='██'

    # get color for string
    if [[ $line == 0 ]]; then
        string='  '
    elif [[ $line < 6 ]]; then
        color=$(( line * 6 + 16 ))
    else
        color=46
    fi

    # add to lines if horizontal
    if [[ $1 == '-v' ]]; then
        print -nP "%F{$color}$string%f"
    else
        lines[$(( count + 1 ))]+="%F{$color}$string%f"
    fi
done

# draw box
if $vertical; then
    print -P '%F{239} │%f'
    print -P '%F{239}└────────────────┘%f'
else
    print -P "%F{239}┌${(l:weeks*2+2::─:)}┐%f"

    for (( i = 2; i <= $#lines; i++ )); do
        print -P "%F{239}│%f ${lines[i]} %F{239}│%f"
    done

    print -P "%F{239}└${(l:weeks*2+2::─:)}┘%f"
fi
